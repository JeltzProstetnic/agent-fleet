#!/usr/bin/env bash
# Git credential helper that reads GitHub PAT from MCP config.
# Checks cc-mirror config first, falls back to ~/.mcp.json.

[ "$1" != "get" ] && exit 0

host=""
while IFS='=' read -r key value; do
    [ "$key" = "host" ] && host="$value"
done

[ "$host" != "github.com" ] && exit 0

# Find MCP config: cc-mirror first, then global fallback
MCP_CONFIG=""
for candidate in \
    "$HOME/.cc-mirror/"*/config/.mcp.json \
    "$HOME/.mcp.json"; do
    [ -f "$candidate" ] && MCP_CONFIG="$candidate" && break
done
[ -z "$MCP_CONFIG" ] && exit 1

token=$(python3 -c "
import json, sys, os
d = json.load(open(sys.argv[1]))
sys.stdout.write(d['mcpServers']['github']['env']['GITHUB_PERSONAL_ACCESS_TOKEN'])
" "$MCP_CONFIG") || exit 1

printf 'protocol=https\nhost=github.com\nusername=x-access-token\npassword=%s\n' "$token"
